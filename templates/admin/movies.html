{% extends "admin/base.html" %}

{% block title %}Quản lý Phim{% endblock %}
{% block page_title %}Quản lý Phim{% endblock %}

{% block content %}
<div class="admin-actions">
    <a href="{{ url_for('admin_add_movie') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Thêm phim mới
    </a>
	<form method="POST" action="{{ url_for('admin_bulk_delete_movies') }}" style="display:inline"
		  onsubmit="return confirm('Bạn chắc chắn muốn xóa TẤT CẢ phim và dữ liệu liên quan? Hành động này không thể hoàn tác!');">
		<button type="submit" class="btn btn-danger">
			<i class="fas fa-trash"></i> Xóa tất cả
		</button>
	</form>
</div>

<div class="admin-section">
    <div class="admin-table-wrapper">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Poster</th>
                    <th>Tên phim</th>
                    <th>Thể loại</th>
                    <th>Lượt xem</th>
                    <th>Ngày tạo</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                {% for movie in movies %}
				<tr data-movie-id="{{ movie.id }}"
					data-video-url="{{ movie.video_url or '' | e }}"
					data-poster-url="{{ movie.poster_url or '' | e }}"
					data-description="{{ (movie.description or '') | e }}"
					data-category-id="{{ movie.category_id or '' }}">
                    <td>{{ movie.id }}</td>
                    <td>
						<img src="{{ movie.poster_url or 'https://via.placeholder.com/120x68?text=No+Image' }}" 
                             alt="{{ movie.title }}" class="table-poster">
                    </td>
                    <td>
						<input type="text" class="quick-title-input" value="{{ movie.title }}" />
					</td>
					<td>
						<select class="quick-category-select">
							<option value="" {% if not movie.category_id %}selected{% endif %}>Chưa chọn</option>
							{% for cat in categories %}
							<option value="{{ cat.id }}" {% if movie.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
							{% endfor %}
						</select>
                    </td>
                    <td>{{ movie.views }}</td>
                    <td>{{ movie.created_at.strftime('%d/%m/%Y') }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="{{ url_for('movie', movie_id=movie.id) }}" 
                               class="btn btn-sm btn-secondary" target="_blank">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ url_for('admin_edit_movie', movie_id=movie.id) }}" 
                               class="btn btn-sm btn-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form method="POST" action="{{ url_for('admin_delete_movie', movie_id=movie.id) }}" 
                                  style="display: inline;" 
                                  onsubmit="return confirm('Bạn có chắc muốn xóa phim này?');">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center">Chưa có phim nào. <a href="{{ url_for('admin_add_movie') }}">Thêm phim đầu tiên</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<!-- Edit modal removed per request; using classic edit page -->
<script>
document.addEventListener('DOMContentLoaded', () => {
	const rows = document.querySelectorAll('tr[data-movie-id]');
	function debounce(fn, t=400) {
		let id; return (...args) => { clearTimeout(id); id = setTimeout(() => fn(...args), t); };
	}
	async function quickUpdate(movieId, payload) {
		try {
			const resp = await fetch(`{{ url_for('admin_quick_update_movie', movie_id=0) }}`.replace('0', String(movieId)), {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			});
			const data = await resp.json();
			if (!data.success) {
				alert(data.error || 'Cập nhật thất bại');
			}
		} catch (e) {
			alert('Cập nhật thất bại');
		}
	}
	// Modal removed
	rows.forEach(row => {
		const movieId = row.getAttribute('data-movie-id');
		const titleInput = row.querySelector('.quick-title-input');
		const catSelect = row.querySelector('.quick-category-select');
		if (titleInput) {
			const send = debounce(() => quickUpdate(movieId, { title: titleInput.value }), 500);
			titleInput.addEventListener('change', send);
			titleInput.addEventListener('input', send);
		}
		if (catSelect) {
			catSelect.addEventListener('change', () => quickUpdate(movieId, { category_id: catSelect.value || null }));
		}
	});
});
</script>
{% endblock %}

