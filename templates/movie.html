{% extends "base.html" %}

{% block title %}Xem phim - NGAY THER{% endblock %}

{% block content %}
<div class="movie-page">
  <div class="movie-content movie-page-layout">
    <!-- LEFT: Player, metadata, description, comments (takes 4/5 on desktop) -->
    <section class="movie-main" aria-label="Movie main">
      <div class="video-section">
        {% if movie.video_url %}
        <div class="video-inner">
          <video class="movie-video" controls playsinline webkit-playsinline poster="{{ movie.poster_url }}" preload="metadata">
            <source src="{{ movie.video_url }}" type="video/mp4">
            {% if movie.subtitle_url %}
            <track kind="captions" label="Tiếng Việt" srclang="vi" src="{{ movie.subtitle_url }}" default>
            {% endif %}
            Trình duyệt của bạn không hỗ trợ video.
          </video>
        </div>
        {% else %}
        <div class="movie-video-unavailable">
          <p>Video không khả dụng.</p>
        </div>
        {% endif %}
      </div>

      <div class="meta-section">
        <h1 class="movie-title">{{ movie.title }}</h1>
        {% if movie.subtitle %}
        <h2 class="movie-subtitle">{{ movie.subtitle }}</h2>
        {% endif %}
        {% if movie.category %}
        <div class="movie-categories">
          <span class="category-tag">{{ movie.category.name }}</span>
        </div>
        {% endif %}
      </div>

      <div class="info-section">
        {% if movie.description %}
        <div class="movie-description">
          <div class="description-content collapsed">{{ movie.description }}</div>
          <button class="toggle-description">Xem thêm</button>
        </div>
        {% endif %}

        <div class="movie-comments">
          <div class="comments-toggle-bar toggle-comments">
            <span class="comment-icon">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 15.5V6.5C21 5.11929 19.8807 4 18.5 4H5.5C4.11929 4 3 5.11929 3 6.5V15.5C3 16.8807 4.11929 18 5.5 18H18.5C19.8807 18 21 16.8807 21 15.5Z" stroke="#888" stroke-width="2"/><path d="M7 10H17" stroke="#888" stroke-width="2" stroke-linecap="round"/><path d="M7 13H13" stroke="#888" stroke-width="2" stroke-linecap="round"/></svg>
            </span>
            <span class="comment-label">Bình luận (<span id="comment-count">0</span>)</span>
            <span class="dropdown-icon" id="commentDropdownIcon" style="margin-left:auto;cursor:pointer;">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5" stroke="#888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
          </div>
          <div class="comments-list collapsed">
            <!-- Comments will be loaded here -->
            <p>Chưa có bình luận nào.</p>
            <div class="comment-form" style="margin-top:12px;">
              <form id="commentForm">
                <textarea name="comment" rows="3" placeholder="Viết bình luận..." required></textarea>
                <button type="submit">Gửi bình luận</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Related / Suggested (takes 1/5 on desktop) -->
    <aside class="related-section" aria-label="Related videos">
      <div class="tabs-header movie-tabs" role="tablist">
        <button class="tab-btn active" data-tab="related" role="tab" aria-selected="true">Video liên quan</button>
        <button class="tab-btn" data-tab="suggested" role="tab" aria-selected="false">Có thể bạn sẽ thích</button>
      </div>

      <div class="tabs-body">
        <div class="tab-content active" id="related" role="tabpanel">
          {% if franchise_movies %}
          <div class="video-cards">
            {% for fm in franchise_movies %}
            <a href="{{ url_for('movie', url_key=fm.url_key or fm.slug or fm.id) }}" class="video-card">
              <img src="{{ fm.poster_url }}" alt="{{ fm.title }}">
              <div class="card-info">
                <h4>{{ fm.title }}</h4>
                {% if fm.subtitle %}<p class="muted">{{ fm.subtitle }}</p>{% endif %}
              </div>
            </a>
            {% endfor %}
          </div>
          {% elif episodes %}
          <div class="video-cards">
            {% for ep in episodes %}
            <a href="{{ url_for('movie', url_key=ep.url_key or ep.slug or ep.id) }}" class="video-card">
              <img src="{{ ep.poster_url }}" alt="{{ ep.title or ep.subtitle or 'Episode ' + ep.episode_number|string }}">
              <div class="card-info">
                <h4>{{ ep.title or ep.subtitle or 'Episode ' + ep.episode_number|string }}</h4>
                {% if ep.subtitle and ep.title %}<p class="muted">{{ ep.subtitle }}</p>{% endif %}
              </div>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <p>Không có video liên quan.</p>
          {% endif %}
        </div>

        <div class="tab-content" id="suggested" role="tabpanel">
          {% if suggested_movies %}
          <div class="video-cards">
            {% for sm in suggested_movies %}
            <a href="{{ url_for('movie', url_key=sm.url_key or sm.slug or sm.id) }}" class="video-card">
              <img src="{{ sm.poster_url }}" alt="{{ sm.title }}">
              <div class="card-info">
                <h4>{{ sm.title }}</h4>
                {% if sm.subtitle %}<p class="muted">{{ sm.subtitle }}</p>{% endif %}
              </div>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <p>Không có gợi ý phim.</p>
          {% endif %}
        </div>
      </div>
    </aside>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tab switcher + simple accessibility updates
document.addEventListener('DOMContentLoaded', function() {
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      tabBtns.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); });
      tabContents.forEach(tc => tc.classList.remove('active'));
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');
      const id = btn.dataset.tab;
      const target = document.getElementById(id);
      if (target) target.classList.add('active');
    });
  });

  // Toggle description
  const toggleDesc = document.querySelector('.toggle-description');
  const descContent = document.querySelector('.description-content');
  if (toggleDesc && descContent) {
    toggleDesc.addEventListener('click', () => {
      descContent.classList.toggle('collapsed');
      toggleDesc.textContent = descContent.classList.contains('collapsed') ? 'Xem thêm' : 'Thu gọn';
    });
  }

  // Toggle comments
  const toggleComments = document.querySelector('.toggle-comments');
  const commentsList = document.querySelector('.comments-list');
  if (toggleComments && commentsList) {
    toggleComments.addEventListener('click', () => {
      commentsList.classList.toggle('collapsed');
    });
  }
});
</script>
{% endblock %}
